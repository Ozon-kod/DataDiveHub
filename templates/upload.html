<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Diving Dashboard</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart-->
</head>
<style>
/* Chrome, Safari, Edge, Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
-webkit-appearance: none;
margin: 0;
}
td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
    cursor: pointer; 
    width: auto; 
}

th {
    background-color: #f2f2f2;
}

tr:hover {
    background-color: #f5f5f5; 
}

table {
    border-collapse: collapse;
    width: 100%; 
}
</style>
<!-- Style for the dive overview--><style>
    .canvas-container {
        display: none;
        position: absolute;
        top: 90%; /* Position below the map */
        left: 320px;
        right: 0;
        height: auto; 
        width: calc(100% - 340px); /
    }

    /* Styles for the canvas and table containers */
    .container {
        padding: 20px;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .canvas-container canvas {
        width: 100%; 
        height: 200px;
    }

    
    .title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }

    .subtitle {
        font-size: 16px;
        font-weight: normal;
        color: #666;
        margin-bottom: 20px;
    }
</style>
<!-- Style for the map --><style>
  #map-container {
    position: absolute;
    display: block;
    top: 10%;
    left: 320px; 
    right: 0;
    bottom: 0;
    z-index: 10; 
  }
  
  #map {
      height: 80%; 
      width: 77.5%; 
  }
  
</style>
<!-- Style for the graph --><style>
  .graph-container {
    position: absolute;
    display: none;
    top: 10%;
    left: 320px; 
    right: 0;
    bottom: 0;
    z-index: 10; 
  }
  </style>
  

<body>
  <div>
    <!-- Navbar and side bar -->
    <nav class="bg-white border-b border-gray-200 fixed z-30 w-full">
      <div class="px-3 py-3 lg:px-5 lg:pl-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center justify-start">
            <button id="toggleSidebarMobile" aria-expanded="true" aria-controls="sidebar"
              class="lg:hidden mr-2 text-gray-600 hover:text-gray-900 cursor-pointer p-2 hover:bg-gray-100 focus:bg-gray-100 focus:ring-2 focus:ring-gray-100 rounded">
              <svg id="toggleSidebarMobileHamburger" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                  d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                  clip-rule="evenodd"></path>
              </svg>
              <svg id="toggleSidebarMobileClose" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"></path>
              </svg>
            </button>
            <a id="diving-return" href="#" class="text-xl font-bold flex items-center lg:ml-2.5">
              <img src="https://demo.themesberg.com/windster/images/logo.svg" class="h-6 mr-2" alt="Windster Logo" />
              <span class="self-center whitespace-nowrap">Diving</span>
            </a>
          </div>
        </div>
      </div>
    </nav>
    <div class="flex overflow-hidden bg-white pt-16">
        <aside id="sidebar"
          class="fixed hidden z-20 h-full top-0 left-0 pt-16 flex lg:flex flex-shrink-0 flex-col w-64 transition-width duration-75"
          aria-label="Sidebar">
          <div class="relative flex-1 flex flex-col min-h-0 border-r border-gray-200 bg-white pt-0">
            <div class="flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
              <div class="flex-1 px-3 bg-white divide-y space-y-1">
                <ul class="space-y-2 pb-2">
                  <li>
                    <a id="dashboard-return" href="#"
                      class="text-base text-gray-900 font-normal rounded-lg flex items-center p-2 hover:bg-gray-100 group">
                      <svg class="w-6 h-6 text-gray-500 group-hover:text-gray-900 transition duration-75"
                        fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                      </svg>
                      <span class="ml-3">Dashboard</span>
                    </a>
                  </li>
                </ul>
                <div class="space-y-2 pt-2">
                    <!-- File input -->
                    <input type="file" id="fileInput" name="xmlFile" class="hidden" />
                    <!-- Upload Data button -->
                    <a id="upload-link" href="#" class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 group transition duration-75 flex items-center p-2">
                        <svg class="w-5 h-5 text-gray-500 flex-shrink-0 group-hover:text-gray-900 transition duration-75"
                            aria-hidden="true" focusable="false" data-prefix="fas" data-icon="gem" role="img"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path fill="currentColor"
                            d="M378.7 32H133.3L256 182.7L378.7 32zM512 192l-107.4-141.3L289.6 192H512zM107.4 50.67L0 192h222.4L107.4 50.67zM244.3 474.9C247.3 478.2 251.6 480 256 480s8.653-1.828 11.67-5.062L510.6 224H1.365L244.3 474.9z">
                            </path>
                        </svg>
                        <span class="ml-4">Upload Data</span>
                    </a>
                  </div>
                  <a href="/download" download="dive_data.csv" target="_blank"
                    class="text-base text-gray-900 font-normal rounded-lg hover:bg-gray-100 group transition duration-75 flex items-center p-2">
                    <svg class="w-6 h-6 text-gray-500 flex-shrink-0 group-hover:text-gray-900 transition duration-75"
                      fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                      <path fill-rule="evenodd"
                        d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                        clip-rule="evenodd"></path>
                    </svg>
                    <span class="ml-3">Download Data</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </aside>
        <div id="map-container" class="h-full w-full">
            <div id="map"></div>
          </div>
            <div class="canvas-container container">
                <div class="title">Dives in location selected</div>
                <div class="subtitle">Click on a dive to see more information</div>
                <!-- Table row -->
                <table>
                  <tbody id="dive-list">
                    <!-- fills out using js -->
                </tbody>
                </table>
                <canvas id="diveTableSummary"></canvas>
            </div>
            <div class="graph-container">
              <canvas id="diveProfile"></canvas>
          </div>
        </div>
    </div>
    
    <!--JS SCRIPTs-->

<!-- Fetch data --><script>
  function fetchData(url, fileName, callback) {
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fileName: fileName })
    })
    .then(response => response.text())
    .then(data => {
        callback(data);
    })
    .catch(error => {
        console.error(`Error fetching ${url}:`, error);
    });
  }
</script>

<!-- Dive profile click --><script>
  function ShowDiveProfileClick(DiveName){
    //Get the rowIndex which has been clicked
    const rowIndex = parseInt(event.currentTarget.getAttribute('new-index'));
    
    fetch('/get-file-list')
     .then(response => response.text())
     .then(fileListString => {
      fileListString = fileListString.slice(1, -2);

      // Split the string into an array of file names
      const fileList = fileListString.split('\\r\\n').filter(fileName => fileName.trim() !== '');
      // Retrieve the file name using the index
      const selectedFileName = fileList[rowIndex];
      console.log('Selected file:', selectedFileName); // Log the selected file name

      // Fetch depth data
      fetchData('/dive-depth', selectedFileName, depthList => {
          depthList = depthList.slice(1, -2).replace(/"/g, "").split(",");
          // Fetch temperature data
          fetchData('/dive-temperature', selectedFileName, tempList => {
              tempList = tempList.slice(1, -2).replace(/"/g, "").split(",");
              // Fetch time data
              fetchData('/dive-time', selectedFileName, timeList => {
                  timeList = timeList.slice(1, -2).replace(/"/g, "").split(",");

                  // Convert the fetched data into arrays of numbers
                  const depthData = depthList.map(entry => parseFloat(entry.trim()));
                  const tempData = tempList.map(entry => parseFloat(entry.trim()));
                  const timeData = timeList.map(entry => parseFloat(entry.trim()));
                  const invertedDepthData = depthData.map(depth => -depth);
                  // Create an array of objects where each object represents a waypoint
                  const waypoints = timeData.map((time, index) => ({
                      time: time,
                      depth: invertedDepthData[index],
                      temp: tempData[index], // Include temperature as an attribute
                  }));

                  // Sort the waypoints by time 
                  waypoints.sort((a, b) => a.time - b.time);

                  // Extract the sorted time, depth, and temperature data
                  const sortedTimeData = waypoints.map(waypoint => waypoint.time);
                  const sortedDepthData = waypoints.map(waypoint => waypoint.depth);
                  const sortedTempData = waypoints.map(waypoint => waypoint.temp);

                  // Create the chart data using the sorted arrays
                  const data = {
                      labels: sortedTimeData, // time on x-axis
                      datasets: [
                          {
                              data: sortedDepthData,
                              borderColor: 'rgba(173, 216, 230, 0.8)',
                              backgroundColor: 'rgba(173, 216, 230, 0.4)',
                              temperature: sortedTempData, //add temp as a dataset to later use it
                          },
                      ],
                  };

                  // Configuration options
                  const config = {
                      type: 'line',
                      data: data,
                      options: {
                          scales: {
                              x: {
                                  title: {
                                      display: true,
                                      text: 'Divetime',
                                  },
                              },
                              y: {
                                  title: {
                                      display: true,
                                      text: 'Depth',
                                  },
                                  beginAtZero: true, // Start the axis at zero
                              },
                          },
                          elements: {
                              line: {
                                  borderWidth: 2,
                                  tension: 0.8,
                              },
                          },
                          plugins: {
                              filler: {
                                  propagate: false,
                              },
                              tooltip: {
                                  mode: 'index',
                                  intersect: false,
                                  callbacks: {
                                      // Custom tooltip function to include temperature
                                      label: function (context) {
                                          let label = context.dataset.label || '';

                                          if (context.parsed.y !== null) {
                                              label += '\nDepth: ' + context.parsed.y*(-1) + ' m';
                                          }

                                          // Include temperature 
                                          if (context.dataset.temperature !== undefined) {
                                              label += '\nTemperature: ' + context.dataset.temperature[context.dataIndex] + ' °C';
                                          }

                                          return label;
                                      },
                                  },
                              },
                          },
                          pointRadius: 0, // Hide data points
                          fill: 'origin', // Fill area below the line
                      },
                  };

                  //chart
                  const myChart = new Chart(
                      document.getElementById('diveProfile'),
                      config
                  );
              });
          });
      });

      document.querySelector('#map-container').style.display= 'none';
      document.querySelector('.graph-container').style.display = 'block';
    })}
</script>

<!-- Map script --> <script>
    
    
    var maxBounds = [
        [90, -180], // North West
        [-90, 180]  // South East
    ];

    var map = L.map('map').setView([51.505, -0.09], 13); // Initialize Leaflet map
    // Add Mapbox tile layer
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: '&copy; <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/outdoors-v12',
            tileSize: 512,
            zoomOffset: -1,
            maxBounds:maxBounds,
            accessToken: 'pk.eyJ1IjoibWFjYW50b21hdG8iLCJhIjoiY2x2MG4xbmU5MWhiMDJpcnprazNhMHBueCJ9.6rufAEhCvcvJQD02SMqGoQ' // Replace with your Mapbox access token
      }).addTo(map);


// Array to store reference to which marker has been clicked
let markers = [];

// Fetch latitude and longitude
fetch('/get-latitude')
  .then(response => response.text())
  .then(latitude => {
    console.log(latitude);
  })
  .catch(error => {
    console.error('Error fetching latitude:', error);
  });

  fetch('/get-longitude')
  .then(response => response.text())
  .then(longitude => {
    console.log(longitude);
  })
  .catch(error => {
    console.error('Error fetching latitude:', error);
  });

// Function to handle marker click event
function handleMarkerClick(clickedMarkerIndex) {
    const clickedMarker = markers[clickedMarkerIndex];
    const clickedLatlng = clickedMarker.getLatLng(); // Get latitude and longitude of clicked marker
    const nearbyDivesIndex = [];
    const threshold = 30000; // 30km away
    document.querySelector('.canvas-container').style.display = 'block';
    // Iterate through all markers to find nearby dives
    markers.forEach((marker, index) => {
        markerLatlng = marker.getLatLng(); // Get latitude and longitude of current marker
        distance = clickedLatlng.distanceTo(markerLatlng); // Calculate distance between markers
        if (distance <= threshold) {
            nearbyDivesIndex.push(markers.indexOf(marker)+1); //Since the list uses index for 1-n and not 0-n
        }
    });
    console.log(nearbyDivesIndex);
    // Fetch dive names and populate the dive list
    fetch('/get-dive-name')
        .then(response => response.text())
        .then(data => { 
            data = data.slice(1, -2);
            let DiveIndex = 0; //File index/row index
            console.log('Data received:', data); // Log the data to the console
            const DiveNames = data.split('\\r\\n').filter(DiveName => DiveName.trim() !== '');
            const DiveListBody = document.getElementById('dive-list');
            
            // Clear existing dive list
            DiveListBody.innerHTML = '';
            trueIndex = 0; //For keeping track of the actual index stored in the array

            DiveNames.forEach((DiveName) => {
                DiveIndex += 1; //Incrementer
                if (nearbyDivesIndex.includes(DiveIndex) || DiveIndex === clickedMarkerIndex + 1) {
                    const row = document.createElement('tr');
                    const DiveNameCell = document.createElement('td');
                    DiveNameCell.textContent = DiveName || 'Unnamed Dive'; // Show 'Unnamed Dive' if no name exists
                    row.addEventListener('click', () => {
                        ShowDiveProfileClick(DiveName);
                    });
                    row.appendChild(DiveNameCell);
                    row.setAttribute('new-index', nearbyDivesIndex[trueIndex]); //Setting index for the row as an attribute
                    DiveListBody.appendChild(row);
                    trueIndex +=1;
                }
            });
        })
        .catch(error => {
            console.error('Error fetching dive names:', error);
        });
}
</script>

<!-- Script for returning to home-page --><script>

    // Add event listener to the dash board click to invis the dive summary
    document.getElementById('dashboard-return').addEventListener('click', function(event) {
      document.querySelector('.graph-container').style.display = 'none';
      document.querySelector('#map-container').style.display = 'block';
    });
    // Add event listener to the dash board click to invis the dive summary
    document.getElementById('diving-return').addEventListener('click', function(event) {
        document.querySelector('.graph-container').style.display = 'none';
        document.querySelector('#map-container').style.display = 'block';
    });
</script>    

<!-- Upload --><script>

    // Function to trigger file input click event
    function triggerFileInput() {
        const fileInput = document.getElementById('fileInput');
        fileInput.click(); // Trigger click event on file input
    }
    // Add event listener to the upload link
    document.getElementById('upload-link').addEventListener('click', function(event) {
        event.preventDefault(); // Prevent the default action of the link
        triggerFileInput(); // Call the function to trigger file input click event
    });

    // Event listener to handle file selection
    document.getElementById('fileInput').addEventListener('change', function() {
        const formData = new FormData(); // Create a FormData object
        formData.append('xmlFile', this.files[0]); // Append the file to the FormData object
        console.log('Selected file:', this.files[0]);
        
        fetch('/upload', {
            method: 'POST',
            body: formData, // Pass the FormData object as the request body
        })
        .then(response => response.json())
        .then(data => {
            console.log('Upload response:', data);
            // Handle upload response if needed
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            // Handle error if needed
        });
    });

</script>
</body>

</html>